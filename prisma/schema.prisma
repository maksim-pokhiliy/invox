generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  emailVerified      DateTime?
  passwordHash       String
  saltEdgeCustomerId String?   @unique
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  accounts          Account[]
  sessions          Session[]
  senderProfile     SenderProfile?
  clients           Client[]
  invoices          Invoice[]
  invoiceTemplates  InvoiceTemplate[]
  followUpRules     FollowUpRule[]
  recurringInvoices RecurringInvoice[]
  bankConnections          BankConnection[]
  timeTrackingConnections  TimeTrackingConnection[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model SenderProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  companyName     String?
  displayName     String?
  emailFrom       String?
  address         String?
  taxId           String?
  defaultCurrency String   @default("USD")
  logoUrl         String?
  primaryColor    String?  @default("#1976d2")
  accentColor     String?  @default("#9c27b0")
  footerText      String?  @db.Text
  fontFamily      String?
  invoicePrefix   String?
  defaultRate     Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Client {
  id          String   @id @default(cuid())
  userId      String
  name        String
  email       String
  defaultRate Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  invoices          Invoice[]
  recurringInvoices RecurringInvoice[]

  @@index([userId])
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  OVERDUE
  PARTIALLY_PAID
  PAID
}

enum PaymentMethod {
  MANUAL
  BANK_TRANSFER
  CASH
  OTHER
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

model Invoice {
  id             String         @id @default(cuid())
  userId         String
  clientId       String
  publicId       String         @unique
  currency       String         @default("USD")
  status         InvoiceStatus  @default(DRAFT)
  subtotal       Int            @default(0)
  discountType   DiscountType?
  discountValue  Int            @default(0)
  discountAmount Int            @default(0)
  taxRate        Int            @default(0)
  taxAmount      Int            @default(0)
  total          Int            @default(0)
  paidAmount     Int            @default(0)
  dueDate        DateTime
  periodStart    DateTime?
  periodEnd      DateTime?
  notes          String?        @db.Text
  message        String?        @db.Text
  tags           Json           @default("[]")
  sentAt         DateTime?
  viewedAt       DateTime?
  paidAt         DateTime?
  paymentMethod  PaymentMethod?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  paymentReference String? @unique

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  client           Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  itemGroups       InvoiceItemGroup[]
  items            InvoiceItem[]
  events           InvoiceEvent[]
  payments         Payment[]
  followUpJobs     FollowUpJob[]
  bankTransactions BankTransaction[]

  @@index([userId])
  @@index([clientId])
  @@index([publicId])
}

model InvoiceItemGroup {
  id        String @id @default(cuid())
  invoiceId String
  title     String
  sortOrder Int    @default(0)

  invoice Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  items   InvoiceItem[]

  @@index([invoiceId])
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoiceId   String
  groupId     String?
  title       String
  description String?
  quantity    Float
  unitPrice   Int
  amount      Int
  sortOrder   Int     @default(0)

  invoice Invoice           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  group   InvoiceItemGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@index([groupId])
}

enum InvoiceEventType {
  CREATED
  SENT
  VIEWED
  REMINDER_SENT
  PAID_MANUAL
  PAYMENT_RECORDED
  STATUS_CHANGED
}

model InvoiceEvent {
  id        String           @id @default(cuid())
  invoiceId String
  type      InvoiceEventType
  payload   Json?
  createdAt DateTime         @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Payment {
  id        String        @id @default(cuid())
  invoiceId String
  amount    Int
  method    PaymentMethod
  note      String?
  paidAt    DateTime      @default(now())
  createdAt DateTime      @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model InvoiceTemplate {
  id            String        @id @default(cuid())
  userId        String
  name          String
  description   String?
  currency      String        @default("USD")
  discountType  DiscountType?
  discountValue Int           @default(0)
  taxRate       Int           @default(0)
  notes         String?       @db.Text
  dueDays       Int           @default(30)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user       User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items      InvoiceTemplateItem[]
  itemGroups InvoiceTemplateItemGroup[]

  @@index([userId])
}

model InvoiceTemplateItemGroup {
  id         String @id @default(cuid())
  templateId String
  title      String
  sortOrder  Int    @default(0)

  template InvoiceTemplate       @relation(fields: [templateId], references: [id], onDelete: Cascade)
  items    InvoiceTemplateItem[]

  @@index([templateId])
}

model InvoiceTemplateItem {
  id          String  @id @default(cuid())
  templateId  String
  groupId     String?
  title       String
  description String?
  quantity    Int
  unitPrice   Int
  sortOrder   Int     @default(0)

  template InvoiceTemplate          @relation(fields: [templateId], references: [id], onDelete: Cascade)
  group    InvoiceTemplateItemGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  @@index([templateId])
  @@index([groupId])
}

enum FollowUpMode {
  AFTER_SENT
  AFTER_DUE
}

model FollowUpRule {
  id         String       @id @default(cuid())
  userId     String
  enabled    Boolean      @default(true)
  mode       FollowUpMode @default(AFTER_SENT)
  delaysDays Json         @default("[1, 3, 7]")
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum FollowUpJobStatus {
  PENDING
  SENT
  CANCELED
}

model FollowUpJob {
  id           String            @id @default(cuid())
  invoiceId    String
  scheduledFor DateTime
  sentAt       DateTime?
  status       FollowUpJobStatus @default(PENDING)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([status, scheduledFor])
}

enum RecurringFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum RecurringStatus {
  ACTIVE
  PAUSED
  CANCELED
}

model RecurringInvoice {
  id            String             @id @default(cuid())
  userId        String
  clientId      String
  name          String
  frequency     RecurringFrequency @default(MONTHLY)
  status        RecurringStatus    @default(ACTIVE)
  currency      String             @default("USD")
  discountType  DiscountType?
  discountValue Int                @default(0)
  taxRate       Int                @default(0)
  notes         String?            @db.Text
  dueDays       Int                @default(30)
  autoSend      Boolean            @default(false)
  nextRunAt     DateTime
  lastRunAt     DateTime?
  endDate       DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  user       User                          @relation(fields: [userId], references: [id], onDelete: Cascade)
  client     Client                        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  items      RecurringInvoiceItem[]
  itemGroups RecurringInvoiceItemGroup[]

  @@index([userId])
  @@index([clientId])
  @@index([status, nextRunAt])
}

model RecurringInvoiceItemGroup {
  id                 String @id @default(cuid())
  recurringInvoiceId String
  title              String
  sortOrder          Int    @default(0)

  recurringInvoice RecurringInvoice       @relation(fields: [recurringInvoiceId], references: [id], onDelete: Cascade)
  items            RecurringInvoiceItem[]

  @@index([recurringInvoiceId])
}

model RecurringInvoiceItem {
  id                 String  @id @default(cuid())
  recurringInvoiceId String
  groupId            String?
  title              String
  description        String?
  quantity           Int
  unitPrice          Int
  sortOrder          Int     @default(0)

  recurringInvoice RecurringInvoice          @relation(fields: [recurringInvoiceId], references: [id], onDelete: Cascade)
  group            RecurringInvoiceItemGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  @@index([recurringInvoiceId])
  @@index([groupId])
}

enum BankTransactionStatus {
  PENDING
  AUTO_MATCHED
  CONFIRMED
  IGNORED
}

model BankConnection {
  id                   String    @id @default(cuid())
  userId               String
  saltEdgeConnectionId String    @unique
  provider             String
  providerName         String
  country              String
  status               String    @default("active")
  lastSyncAt           DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  accounts BankAccount[]

  @@index([userId])
}

model BankAccount {
  id                String   @id @default(cuid())
  connectionId      String
  saltEdgeAccountId String   @unique
  name              String
  nature            String
  balance           Int
  currencyCode      String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  connection   BankConnection    @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  transactions BankTransaction[]

  @@index([connectionId])
}

model BankTransaction {
  id               String                @id @default(cuid())
  accountId        String
  saltEdgeId       String                @unique
  amount           Int
  currencyCode     String
  description      String
  madeOn           DateTime
  status           BankTransactionStatus @default(PENDING)
  matchedInvoiceId String?
  matchConfidence  Float?
  createdAt        DateTime              @default(now())

  account        BankAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  matchedInvoice Invoice?    @relation(fields: [matchedInvoiceId], references: [id])

  @@index([accountId])
  @@index([matchedInvoiceId])
}

model TimeTrackingConnection {
  id             String    @id @default(cuid())
  userId         String
  provider       String
  encryptedToken String
  label          String?
  metadata       Json?
  connectedAt    DateTime  @default(now())
  lastUsedAt     DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
}

enum WaitlistStatus {
  PENDING
  APPROVED
}

model WaitlistEntry {
  id        String         @id @default(cuid())
  email     String         @unique
  status    WaitlistStatus @default(PENDING)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}
